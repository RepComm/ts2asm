import { Scanner } from "../../tokenizer/scanner.js";
import { Token } from "../../tokenizer/token.js";
const numbers = "0123456789";
const ops = "-+/*%=";
const ws = " \n";
const nl = "\n";
const idents = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789";
const terms = ":;.,";
const paren = "()";
const brackets = "{[]}";
export class TypeScriptScanner extends Scanner {
  static IDENTIFIER = Token.TYPE_IDENTIFIER;
  static KEYWORD = "keyw";
  static STRING_LITERAL = Token.TYPE_STRING_LITERAL;
  static NUMBER_LITERAL = Token.TYPE_NUMBER_LITERAL;
  static OPERATOR = Token.TYPE_OPERATOR;
  static BRACKET = "brak";
  static TERMINATOR = Token.TYPE_TERMINATOR;
  static WHITESPACE = Token.TYPE_WHITESPACE;
  static PARENTHESIS = "pare";

  constructor() {
    super();
    this.addPass(TypeScriptScanner.NUMBER_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (numbers.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.IDENTIFIER, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (idents.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.STRING_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      let matchQuote;
      let ignoreNextMatchQuote = false;
      let char = data.charAt(offset);

      if (char == "\"") {
        matchQuote = char;
      } else if (char == "'") {
        matchQuote = char;
      } else if (char == "`") {
        matchQuote = char;
      } else {
        return result;
      }

      result.readChars++;

      for (let i = offset + 1; i < data.length; i++) {
        char = data.charAt(i);

        if (char == matchQuote) {
          if (!ignoreNextMatchQuote) {
            result.success = true;
            result.readChars++;
            return result;
          }
        } else if (char == "\\") {
          ignoreNextMatchQuote = true;
        } else {
          if (ignoreNextMatchQuote) ignoreNextMatchQuote = false;
        }

        result.readChars++;
      }

      return result;
    }).addPass(TypeScriptScanner.OPERATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (ops.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.BRACKET, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (brackets.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.PARENTHESIS, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (paren.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.TERMINATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (terms.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.WHITESPACE, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      for (let i = offset; i < data.length; i++) {
        if (ws.includes(data.charAt(i))) {
          // console.log(`WS: "${data.charAt(i)}"`);
          if (data.charAt(i) == nl) {
            result.readLines++;
          }

          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      }

      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYW5ncy90eXBlc2NyaXB0L3R5cGVzY3JpcHQudHMiXSwibmFtZXMiOlsiU2Nhbm5lciIsIlRva2VuIiwibnVtYmVycyIsIm9wcyIsIndzIiwibmwiLCJpZGVudHMiLCJ0ZXJtcyIsInBhcmVuIiwiYnJhY2tldHMiLCJUeXBlU2NyaXB0U2Nhbm5lciIsIklERU5USUZJRVIiLCJUWVBFX0lERU5USUZJRVIiLCJLRVlXT1JEIiwiU1RSSU5HX0xJVEVSQUwiLCJUWVBFX1NUUklOR19MSVRFUkFMIiwiTlVNQkVSX0xJVEVSQUwiLCJUWVBFX05VTUJFUl9MSVRFUkFMIiwiT1BFUkFUT1IiLCJUWVBFX09QRVJBVE9SIiwiQlJBQ0tFVCIsIlRFUk1JTkFUT1IiLCJUWVBFX1RFUk1JTkFUT1IiLCJXSElURVNQQUNFIiwiVFlQRV9XSElURVNQQUNFIiwiUEFSRU5USEVTSVMiLCJjb25zdHJ1Y3RvciIsImFkZFBhc3MiLCJkYXRhIiwib2Zmc2V0IiwicmVzdWx0Iiwic3VjY2VzcyIsInJlYWRDaGFycyIsInJlYWRMaW5lcyIsIm1heCIsIk1hdGgiLCJtaW4iLCJsZW5ndGgiLCJpIiwiaW5jbHVkZXMiLCJjaGFyQXQiLCJtYXRjaFF1b3RlIiwiaWdub3JlTmV4dE1hdGNoUXVvdGUiLCJjaGFyIl0sIm1hcHBpbmdzIjoiQUFDQSxTQUFTQSxPQUFULFFBQXFDLDRCQUFyQztBQUNBLFNBQVNDLEtBQVQsUUFBc0IsMEJBQXRCO0FBRUEsTUFBTUMsT0FBTyxHQUFHLFlBQWhCO0FBQ0EsTUFBTUMsR0FBRyxHQUFHLFFBQVo7QUFDQSxNQUFNQyxFQUFFLEdBQUcsS0FBWDtBQUNBLE1BQU1DLEVBQUUsR0FBRyxJQUFYO0FBQ0EsTUFBTUMsTUFBTSxHQUFHLGlFQUFmO0FBQ0EsTUFBTUMsS0FBSyxHQUFHLE1BQWQ7QUFDQSxNQUFNQyxLQUFLLEdBQUcsSUFBZDtBQUNBLE1BQU1DLFFBQVEsR0FBRyxNQUFqQjtBQUVBLE9BQU8sTUFBTUMsaUJBQU4sU0FBZ0NW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SCxFQW9KR0gsT0FwSkgsQ0FvSldqQixpQkFBaUIsQ0FBQ2EsVUFwSjdCLEVBb0p5QyxDQUFDSyxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDdkQsVUFBSUMsTUFBbUIsR0FBRztBQUN4QkMsUUFBQUEsT0FBTyxFQUFFLEtBRGU7QUFFeEJDLFFBQUFBLFNBQVMsRUFBRSxDQUZhO0FBR3hCQyxRQUFBQSxTQUFTLEVBQUU7QUFIYSxPQUExQjs7QUFNQSxXQUFLLElBQUlLLENBQUMsR0FBR1QsTUFBYixFQUFxQlMsQ0FBQyxHQUFHVixJQUFJLENBQUNTLE1BQTlCLEVBQXNDQyxDQUFDLEVBQXZDLEVBQTJDO0FBQ3pDLFlBQUlsQyxFQUFFLENBQUNtQyxRQUFILENBQVlYLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLENBQVosQ0FBSixFQUFpQztBQUMvQjtBQUNBLGNBQUlWLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLEtBQWtCakMsRUFBdEIsRUFBMEI7QUFDeEJ5QixZQUFBQSxNQUFNLENBQUNHLFNBQVA7QUFDRDs7QUFDREgsVUFBQUEsTUFBTSxDQUFDRSxTQUFQO0FBQ0QsU0FORCxNQU1PO0FBQ0wsY0FBSUYsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixZQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxpQkFBT0QsTUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsVUFBSUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxhQUFPRCxNQUFQO0FBQ0QsS0E3S0g7QUE4S0Q7O0FBMUw0QyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgU2Nhbm5lciwgU2Nhbm5lckRhdGEgfSBmcm9tIFwiLi4vLi4vdG9rZW5pemVyL3NjYW5uZXIuanNcIjtcbmltcG9ydCB7IFRva2VuIH0gZnJvbSBcIi4uLy4uL3Rva2VuaXplci90b2tlbi5qc1wiO1xuXG5jb25zdCBudW1iZXJzID0gXCIwMTIzNDU2Nzg5XCI7XG5jb25zdCBvcHMgPSBcIi0rLyolPVwiO1xuY29uc3Qgd3MgPSBcIiBcXG5cIjtcbmNvbnN0IG5sID0gXCJcXG5cIjtcbmNvbnN0IGlkZW50cyA9IFwiYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXpBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWl8wMTIzNDU2Nzg5XCI7XG5jb25zdCB0ZXJtcyA9IFwiOjsuLFwiXG5jb25zdCBwYXJlbiA9IFwiKClcIjtcbmNvbnN0IGJyYWNrZXRzID0gXCJ7W119XCI7XG5cbmV4cG9ydCBjbGFzcyBUeXBlU2NyaXB0U2Nhbm5lciBleHRlbmRzIFNjYW5uZXIge1xuICBzdGF0aWMgSURFTlRJRklFUjogc3RyaW5nID0gVG9rZW4uVFlQRV9JREVOVElGSUVSO1xuICBzdGF0aWMgS0VZV09SRDogc3RyaW5nID0gXCJrZXl3XCI7XG4gIHN0YXRpYyBTVFJJTkdfTElURVJBTDogc3RyaW5nID0gVG9rZW4uVFlQRV9TVFJJTkdfTElURVJBTDtcbiAgc3RhdGljIE5VTUJFUl9MSVRFUkFMOiBzdHJpbmcgPSBUb2tlbi5UWVBFX05VTUJFUl9MSVRFUkFMO1xuICBzdGF0aWMgT1BFUkFUT1I6IHN0cmluZyA9IFRva2VuLlRZUEVfT1BFUkFUT1I7XG4gIHN0YXRpYyBCUkFDS0VUOiBzdHJpbmcgPSBcImJyYWtcIjtcbiAgc3RhdGljIFRFUk1JTkFUT1I6IHN0cmluZyA9IFRva2VuLlRZUEVfVEVSTUlOQVRPUjtcbiAgc3RhdGljIFdISVRFU1BBQ0U6IHN0cmluZyA9IFRva2VuLlRZUEVfV0hJVEVTUEFDRTtcbiAgc3RhdGljIFBBUkVOVEhFU0lTOiBzdHJpbmcgPSBcInBhcmVcIjtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmFkZFBhc3MoVHlwZVNjcmlwdFNjYW5uZXIuTlVNQkVSX0xJVEVSQUwsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1heCA9IE1hdGgubWluKGRhdGEubGVuZ3RoLCBvZmZzZXQgKyAzMDkpO1xuXG4gICAgICAvL25vIG5lZWQgdG8gc2NhbiBwYXN0IHdoYXQgd2UgY2FuJ3QgaGFuZGxlLCB1c2Ugb25seSAzMDkgbWF4IGNoYXJzXG4gICAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgbWF4OyBpKyspIHtcbiAgICAgICAgaWYgKG51bWJlcnMuaW5jbHVkZXMoZGF0YS5jaGFyQXQoaSkpKSB7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBpZiAobnVtYmVycy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQrbWF4KSkpIHtcbiAgICAgIC8vICAgcmVzdWx0LnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgIC8vICAgcmVzdWx0LmVycm9yID0gYHRvbyBtYW55IG51bWJlciBjaGFycyBmb3IgYSBsaXRlcmFsOiAke2RhdGEuc3Vic3RyaW5nKG9mZnNldCwgb2Zmc2V0K21heCl9YDtcbiAgICAgIC8vIH1cbiAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLklERU5USUZJRVIsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IG1heCA9IE1hdGgubWluKGRhdGEubGVuZ3RoLCBvZmZzZXQgKyAzMDkpO1xuXG4gICAgICAgIC8vbm8gbmVlZCB0byBzY2FuIHBhc3Qgd2hhdCB3ZSBjYW4ndCBoYW5kbGUsIHVzZSBvbmx5IDMwOSBtYXggY2hhcnNcbiAgICAgICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IG1heDsgaSsrKSB7XG4gICAgICAgICAgaWYgKGlkZW50cy5pbmNsdWRlcyhkYXRhLmNoYXJBdChpKSkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIGlmIChudW1iZXJzLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCttYXgpKSkge1xuICAgICAgICAvLyAgIHJlc3VsdC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIC8vICAgcmVzdWx0LmVycm9yID0gYHRvbyBtYW55IG51bWJlciBjaGFycyBmb3IgYSBsaXRlcmFsOiAke2RhdGEuc3Vic3RyaW5nKG9mZnNldCwgb2Zmc2V0K21heCl9YDtcbiAgICAgICAgLy8gfVxuICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLlNUUklOR19MSVRFUkFMLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbWF0Y2hRdW90ZTogc3RyaW5nO1xuICAgICAgICBsZXQgaWdub3JlTmV4dE1hdGNoUXVvdGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgICAgICBsZXQgY2hhciA9IGRhdGEuY2hhckF0KG9mZnNldCk7XG4gICAgICAgIGlmIChjaGFyID09IFwiXFxcIlwiKSB7XG4gICAgICAgICAgbWF0Y2hRdW90ZSA9IGNoYXI7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PSBcIidcIikge1xuICAgICAgICAgIG1hdGNoUXVvdGUgPSBjaGFyO1xuICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT0gXCJgXCIpIHtcbiAgICAgICAgICBtYXRjaFF1b3RlID0gY2hhcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcblxuICAgICAgICBmb3IgKGxldCBpID0gb2Zmc2V0ICsgMTsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjaGFyID0gZGF0YS5jaGFyQXQoaSk7XG4gICAgICAgICAgaWYgKGNoYXIgPT0gbWF0Y2hRdW90ZSkge1xuICAgICAgICAgICAgaWYgKCFpZ25vcmVOZXh0TWF0Y2hRdW90ZSkge1xuICAgICAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT0gXCJcXFxcXCIpIHtcbiAgICAgICAgICAgIGlnbm9yZU5leHRNYXRjaFF1b3RlID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlnbm9yZU5leHRNYXRjaFF1b3RlKSBpZ25vcmVOZXh0TWF0Y2hRdW90ZSA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLk9QRVJBVE9SLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG9wcy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLkJSQUNLRVQsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAoYnJhY2tldHMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5QQVJFTlRIRVNJUywgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG4gICAgICAgIGlmIChwYXJlbi5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLlRFUk1JTkFUT1IsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAodGVybXMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5XSElURVNQQUNFLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcblxuICAgICAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmICh3cy5pbmNsdWRlcyhkYXRhLmNoYXJBdChpKSkpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBXUzogXCIke2RhdGEuY2hhckF0KGkpfVwiYCk7XG4gICAgICAgICAgICBpZiAoZGF0YS5jaGFyQXQoaSkgPT0gbmwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnJlYWRMaW5lcysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KTtcbiAgfVxufVxuIl19