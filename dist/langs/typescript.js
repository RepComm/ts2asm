import { Parser } from "../parser/parser.js";
import { Scanner } from "../tokenizer/scanner.js";
import { Token } from "../tokenizer/token.js";
const numbers = "0123456789";
const ops = "-+/*%=";
const ws = " \n";
const nl = "\n";
const idents = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_";
const terms = ":;.,";
const paren = "()";
const brackets = "{[]}";
export class TypeScriptScanner extends Scanner {
  static IDENTIFIER = Token.TYPE_IDENTIFIER;
  static STRING_LITERAL = Token.TYPE_STRING_LITERAL;
  static NUMBER_LITERAL = Token.TYPE_NUMBER_LITERAL;
  static OPERATOR = Token.TYPE_OPERATOR;
  static BRACKET = "brak";
  static TERMINATOR = Token.TYPE_TERMINATOR;
  static WHITESPACE = Token.TYPE_WHITESPACE;
  static PARENTHESIS = "pare";

  constructor() {
    super();
    this.addPass(TypeScriptScanner.IDENTIFIER, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (idents.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.STRING_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      let matchQuote;
      let ignoreNextMatchQuote = false;
      let char = data.charAt(offset);

      if (char == "\"") {
        matchQuote = char;
      } else if (char == "'") {
        matchQuote = char;
      } else if (char == "`") {
        matchQuote = char;
      } else {
        return result;
      }

      result.readChars++;

      for (let i = offset + 1; i < data.length; i++) {
        char = data.charAt(i);

        if (char == matchQuote) {
          if (!ignoreNextMatchQuote) {
            result.success = true;
            result.readChars++;
            return result;
          }
        } else if (char == "\\") {
          ignoreNextMatchQuote = true;
        } else {
          if (ignoreNextMatchQuote) ignoreNextMatchQuote = false;
        }

        result.readChars++;
      }

      return result;
    }).addPass(TypeScriptScanner.NUMBER_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (numbers.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.OPERATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (ops.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.BRACKET, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (brackets.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.PARENTHESIS, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (paren.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.TERMINATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (terms.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.WHITESPACE, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      for (let i = offset; i < data.length; i++) {
        if (ws.includes(data.charAt(i))) {
          // console.log(`WS: "${data.charAt(i)}"`);
          if (data.charAt(i) == nl) {
            result.readLines++;
          }

          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      }

      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    });
  }

}
export class TypeScriptParser extends Parser {
  constructor() {
    super();
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5ncy90eXBlc2NyaXB0LnRzIl0sIm5hbWVzIjpbIlBhcnNlciIsIlNjYW5uZXIiLCJUb2tlbiIsIm51bWJlcnMiLCJvcHMiLCJ3cyIsIm5sIiwiaWRlbnRzIiwidGVybXMiLCJwYXJlbiIsImJyYWNrZXRzIiwiVHlwZVNjcmlwdFNjYW5uZXIiLCJJREVOVElGSUVSIiwiVFlQRV9JREVOVElGSUVSIiwiU1RSSU5HX0xJVEVSQUwiLCJUWVBFX1NUUklOR19MSVRFUkFMIiwiTlVNQkVSX0xJVEVSQUwiLCJUWVBFX05VTUJFUl9MSVRFUkFMIiwiT1BFUkFUT1IiLCJUWVBFX09QRVJBVE9SIiwiQlJBQ0tFVCIsIlRFUk1JTkFUT1IiLCJUWVBFX1RFUk1JTkFUT1IiLCJXSElURVNQQUNFIiwiVFlQRV9XSElURVNQQUNFIiwiUEFSRU5USEVTSVMiLCJjb25zdHJ1Y3RvciIsImFkZFBhc3MiLCJkYXRhIiwib2Zmc2V0IiwicmVzdWx0Iiwic3VjY2VzcyIsInJlYWRDaGFycyIsInJlYWRMaW5lcyIsIm1heCIsIk1hdGgiLCJtaW4iLCJsZW5ndGgiLCJpIiwiaW5jbHVkZXMiLCJjaGFyQXQiLCJtYXRjaFF1b3RlIiwiaWdub3JlTmV4dE1hdGNoUXVvdGUiLCJjaGFyIiwiVHlwZVNjcmlwdFBhcnNlciJdLCJtYXBwaW5ncyI6IkFBQ0EsU0FBU0EsTUFBVCxRQUF1QixxQkFBdkI7QUFFQSxTQUFTQyxPQUFULFFBQXFDLHlCQUFyQztBQUNBLFNBQVNDLEtBQVQsUUFBc0IsdUJBQXRCO0FBRUEsTUFBTUMsT0FBTyxHQUFHLFlBQWhCO0FBQ0EsTUFBTUMsR0FBRyxHQUFHLFFBQVo7QUFDQSxNQUFNQyxFQUFFLEdBQUcsS0FBWDtBQUNBLE1BQU1DLEVBQUUsR0FBRyxJQUFYO0FBQ0EsTUFBTUMsTUFBTSxHQUFHLHVEQUFmO0FBQ0EsTUFBTUMsS0FBSyxHQUFHLE1BQWQ7QUFDQSxNQUFNQyxLQUFLLEdBQUcsSUFBZDtBQUNBLE1BQU1DLFFBQVEsR0FBRyxN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c2VyL3BhcnNlci5qc1wiO1xuXG5pbXBvcnQgeyBTY2FubmVyLCBTY2FubmVyRGF0YSB9IGZyb20gXCIuLi90b2tlbml6ZXIvc2Nhbm5lci5qc1wiO1xuaW1wb3J0IHsgVG9rZW4gfSBmcm9tIFwiLi4vdG9rZW5pemVyL3Rva2VuLmpzXCI7XG5cbmNvbnN0IG51bWJlcnMgPSBcIjAxMjM0NTY3ODlcIjtcbmNvbnN0IG9wcyA9IFwiLSsvKiU9XCI7XG5jb25zdCB3cyA9IFwiIFxcblwiO1xuY29uc3QgbmwgPSBcIlxcblwiO1xuY29uc3QgaWRlbnRzID0gXCJhYmNkZWZnaGlqa2xtbm9wcXJzdHV2d3h5ekFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaX1wiO1xuY29uc3QgdGVybXMgPSBcIjo7LixcIlxuY29uc3QgcGFyZW4gPSBcIigpXCI7XG5jb25zdCBicmFja2V0cyA9IFwie1tdfVwiO1xuXG5leHBvcnQgY2xhc3MgVHlwZVNjcmlwdFNjYW5uZXIgZXh0ZW5kcyBTY2FubmVyIHtcbiAgc3RhdGljIElERU5USUZJRVI6IHN0cmluZyA9IFRva2VuLlRZUEVfSURFTlRJRklFUjtcbiAgc3RhdGljIFNUUklOR19MSVRFUkFMOiBzdHJpbmcgPSBUb2tlbi5UWVBFX1NUUklOR19MSVRFUkFMO1xuICBzdGF0aWMgTlVNQkVSX0xJVEVSQUw6IHN0cmluZyA9IFRva2VuLlRZUEVfTlVNQkVSX0xJVEVSQUw7XG4gIHN0YXRpYyBPUEVSQVRPUjogc3RyaW5nID0gVG9rZW4uVFlQRV9PUEVSQVRPUjtcbiAgc3RhdGljIEJSQUNLRVQ6IHN0cmluZyA9IFwiYnJha1wiO1xuICBzdGF0aWMgVEVSTUlOQVRPUjogc3RyaW5nID0gVG9rZW4uVFlQRV9URVJNSU5BVE9SO1xuICBzdGF0aWMgV0hJVEVTUEFDRTogc3RyaW5nID0gVG9rZW4uVFlQRV9XSElURVNQQUNFO1xuICBzdGF0aWMgUEFSRU5USEVTSVM6IHN0cmluZyA9IFwicGFyZVwiO1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5JREVOVElGSUVSLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtYXggPSBNYXRoLm1pbihkYXRhLmxlbmd0aCwgb2Zmc2V0ICsgMzA5KTtcblxuICAgICAgLy9ubyBuZWVkIHRvIHNjYW4gcGFzdCB3aGF0IHdlIGNhbid0IGhhbmRsZSwgdXNlIG9ubHkgMzA5IG1heCBjaGFyc1xuICAgICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IG1heDsgaSsrKSB7XG4gICAgICAgIGlmIChpZGVudHMuaW5jbHVkZXMoZGF0YS5jaGFyQXQoaSkpKSB7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBpZiAobnVtYmVycy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQrbWF4KSkpIHtcbiAgICAgIC8vICAgcmVzdWx0LnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgIC8vICAgcmVzdWx0LmVycm9yID0gYHRvbyBtYW55IG51bWJlciBjaGFycyBmb3IgYSBsaXRlcmFsOiAke2RhdGEuc3Vic3RyaW5nKG9mZnNldCwgb2Zmc2V0K21heCl9YDtcbiAgICAgIC8vIH1cbiAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLlNUUklOR19MSVRFUkFMLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcblxuICAgICAgICBsZXQgbWF0Y2hRdW90ZTogc3RyaW5nO1xuICAgICAgICBsZXQgaWdub3JlTmV4dE1hdGNoUXVvdGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAgICAgICBsZXQgY2hhciA9IGRhdGEuY2hhckF0KG9mZnNldCk7XG4gICAgICAgIGlmIChjaGFyID09IFwiXFxcIlwiKSB7XG4gICAgICAgICAgbWF0Y2hRdW90ZSA9IGNoYXI7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PSBcIidcIikge1xuICAgICAgICAgIG1hdGNoUXVvdGUgPSBjaGFyO1xuICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT0gXCJgXCIpIHtcbiAgICAgICAgICBtYXRjaFF1b3RlID0gY2hhcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcblxuICAgICAgICBmb3IgKGxldCBpID0gb2Zmc2V0ICsgMTsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBjaGFyID0gZGF0YS5jaGFyQXQoaSk7XG4gICAgICAgICAgaWYgKGNoYXIgPT0gbWF0Y2hRdW90ZSkge1xuICAgICAgICAgICAgaWYgKCFpZ25vcmVOZXh0TWF0Y2hRdW90ZSkge1xuICAgICAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT0gXCJcXFxcXCIpIHtcbiAgICAgICAgICAgIGlnbm9yZU5leHRNYXRjaFF1b3RlID0gdHJ1ZTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlnbm9yZU5leHRNYXRjaFF1b3RlKSBpZ25vcmVOZXh0TWF0Y2hRdW90ZSA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLk5VTUJFUl9MSVRFUkFMLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBtYXggPSBNYXRoLm1pbihkYXRhLmxlbmd0aCwgb2Zmc2V0ICsgMzA5KTtcblxuICAgICAgICAvL25vIG5lZWQgdG8gc2NhbiBwYXN0IHdoYXQgd2UgY2FuJ3QgaGFuZGxlLCB1c2Ugb25seSAzMDkgbWF4IGNoYXJzXG4gICAgICAgIGZvciAobGV0IGkgPSBvZmZzZXQ7IGkgPCBtYXg7IGkrKykge1xuICAgICAgICAgIGlmIChudW1iZXJzLmluY2x1ZGVzKGRhdGEuY2hhckF0KGkpKSkge1xuICAgICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gaWYgKG51bWJlcnMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0K21heCkpKSB7XG4gICAgICAgIC8vICAgcmVzdWx0LnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgICAgLy8gICByZXN1bHQuZXJyb3IgPSBgdG9vIG1hbnkgbnVtYmVyIGNoYXJzIGZvciBhIGxpdGVyYWw6ICR7ZGF0YS5zdWJzdHJpbmcob2Zmc2V0LCBvZmZzZXQrbWF4KX1gO1xuICAgICAgICAvLyB9XG4gICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoVHlwZVNjcmlwdFNjYW5uZXIuT1BFUkFUT1IsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAob3BzLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCkpKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMgPSAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoVHlwZVNjcmlwdFNjYW5uZXIuQlJBQ0tFVCwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG4gICAgICAgIGlmIChicmFja2V0cy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLlBBUkVOVEhFU0lTLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHBhcmVuLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCkpKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMgPSAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoVHlwZVNjcmlwdFNjYW5uZXIuVEVSTUlOQVRPUiwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG4gICAgICAgIGlmICh0ZXJtcy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLldISVRFU1BBQ0UsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAobGV0IGkgPSBvZmZzZXQ7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgaWYgKHdzLmluY2x1ZGVzKGRhdGEuY2hhckF0KGkpKSkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFdTOiBcIiR7ZGF0YS5jaGFyQXQoaSl9XCJgKTtcbiAgICAgICAgICAgIGlmIChkYXRhLmNoYXJBdChpKSA9PSBubCkge1xuICAgICAgICAgICAgICByZXN1bHQucmVhZExpbmVzKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUeXBlU2NyaXB0UGFyc2VyIGV4dGVuZHMgUGFyc2VyIHtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgfVxufVxuIl19