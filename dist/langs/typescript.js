import { Scanner } from "../tokenizer/scanner.js";
import { Token } from "../tokenizer/token.js";
const numbers = "0123456789";
const ops = "-+/*%=";
const ws = " \n";
const nl = "\n";
const idents = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_";
const terms = ":;.,";
const paren = "()";
const brackets = "{[]}";
export class TypeScriptScanner extends Scanner {
  static IDENTIFIER = Token.TYPE_IDENTIFIER;
  static KEYWORD = "keyw";
  static STRING_LITERAL = Token.TYPE_STRING_LITERAL;
  static NUMBER_LITERAL = Token.TYPE_NUMBER_LITERAL;
  static OPERATOR = Token.TYPE_OPERATOR;
  static BRACKET = "brak";
  static TERMINATOR = Token.TYPE_TERMINATOR;
  static WHITESPACE = Token.TYPE_WHITESPACE;
  static PARENTHESIS = "pare";

  constructor() {
    super();
    this.addPass(TypeScriptScanner.IDENTIFIER, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (idents.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.STRING_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      let matchQuote;
      let ignoreNextMatchQuote = false;
      let char = data.charAt(offset);

      if (char == "\"") {
        matchQuote = char;
      } else if (char == "'") {
        matchQuote = char;
      } else if (char == "`") {
        matchQuote = char;
      } else {
        return result;
      }

      result.readChars++;

      for (let i = offset + 1; i < data.length; i++) {
        char = data.charAt(i);

        if (char == matchQuote) {
          if (!ignoreNextMatchQuote) {
            result.success = true;
            result.readChars++;
            return result;
          }
        } else if (char == "\\") {
          ignoreNextMatchQuote = true;
        } else {
          if (ignoreNextMatchQuote) ignoreNextMatchQuote = false;
        }

        result.readChars++;
      }

      return result;
    }).addPass(TypeScriptScanner.NUMBER_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (numbers.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(TypeScriptScanner.OPERATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (ops.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.BRACKET, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (brackets.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.PARENTHESIS, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (paren.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.TERMINATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (terms.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(TypeScriptScanner.WHITESPACE, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      for (let i = offset; i < data.length; i++) {
        if (ws.includes(data.charAt(i))) {
          // console.log(`WS: "${data.charAt(i)}"`);
          if (data.charAt(i) == nl) {
            result.readLines++;
          }

          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      }

      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9sYW5ncy90eXBlc2NyaXB0LnRzIl0sIm5hbWVzIjpbIlNjYW5uZXIiLCJUb2tlbiIsIm51bWJlcnMiLCJvcHMiLCJ3cyIsIm5sIiwiaWRlbnRzIiwidGVybXMiLCJwYXJlbiIsImJyYWNrZXRzIiwiVHlwZVNjcmlwdFNjYW5uZXIiLCJJREVOVElGSUVSIiwiVFlQRV9JREVOVElGSUVSIiwiS0VZV09SRCIsIlNUUklOR19MSVRFUkFMIiwiVFlQRV9TVFJJTkdfTElURVJBTCIsIk5VTUJFUl9MSVRFUkFMIiwiVFlQRV9OVU1CRVJfTElURVJBTCIsIk9QRVJBVE9SIiwiVFlQRV9PUEVSQVRPUiIsIkJSQUNLRVQiLCJURVJNSU5BVE9SIiwiVFlQRV9URVJNSU5BVE9SIiwiV0hJVEVTUEFDRSIsIlRZUEVfV0hJVEVTUEFDRSIsIlBBUkVOVEhFU0lTIiwiY29uc3RydWN0b3IiLCJhZGRQYXNzIiwiZGF0YSIsIm9mZnNldCIsInJlc3VsdCIsInN1Y2Nlc3MiLCJyZWFkQ2hhcnMiLCJyZWFkTGluZXMiLCJtYXgiLCJNYXRoIiwibWluIiwibGVuZ3RoIiwiaSIsImluY2x1ZGVzIiwiY2hhckF0IiwibWF0Y2hRdW90ZSIsImlnbm9yZU5leHRNYXRjaFF1b3RlIiwiY2hhciJdLCJtYXBwaW5ncyI6IkFBQ0EsU0FBU0EsT0FBVCxRQUFxQyx5QkFBckM7QUFDQSxTQUFTQyxLQUFULFFBQXNCLHVCQUF0QjtBQUVBLE1BQU1DLE9BQU8sR0FBRyxZQUFoQjtBQUNBLE1BQU1DLEdBQUcsR0FBRyxRQUFaO0FBQ0EsTUFBTUMsRUFBRSxHQUFHLEtBQVg7QUFDQSxNQUFNQyxFQUFFLEdBQUcsSUFBWDtBQUNBLE1BQU1DLE1BQU0sR0FBRyx1REFBZjtBQUNBLE1BQU1DLEtBQUssR0FBRyxNQUFkO0FBQ0EsTUFBTUMsS0FBSyxHQUFHLElBQWQ7QUFDQSxNQUFNQyxRQUFRLEdBQUcsTUFBakI7QUFFQSxPQUFPLE1BQU1DLGlCQUFOLFNBQWdDVixPQUFoQyxDQUF3QztBQUM3QyxTQUFPVyxVQUFQLEdBQTRCVixLQUFLLENBQUNXLGVBQWxDO0FBQ0EsU0FBT0MsT0FBUCxHQUF5QixNQUF6QjtBQUNBLFNBQU9DLGNBQVAsR0FBZ0NiLEtBQUssQ0FBQ2MsbUJBQXRDO0FBQ0EsU0FBT0MsY0FBUCxHQUFnQ2YsS0FBSyxDQUFDZ0IsbUJBQXRDO0FBQ0EsU0FBT0MsUUFBUCxHQUEwQmpCLEtBQUssQ0FBQ2tCLGFBQWhDO0FBQ0EsU0FBT0MsT0FBUCxHQUF5QixNQUF6QjtBQUNBLFNBQU9DLFVBQVAsR0FBNEJwQixLQUFLLENBQUNxQixlQUFsQztBQUNBLFNBQU9DLFVBQVAsR0FBNEJ0QixLQUFLLENBQUN1QixlQUFsQztBQUNBLFNBQU9DLFdBQVAsR0FBNkIsTUFBN0I7O0FBQ0FDLEVBQUFBLFdBQVcsR0FBRztBQUNaO0FBQ0EsU0FBS0MsT0FBTCxDQUFhakIsaUJBQWlCLENBQUNDLFVBQS9CLEVBQTJDLENBQUNpQixJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDM0QsVUFBSUMsTUFBbUIsR0FBRztBQUN4QkMsUUFBQUEsT0FBTyxFQUFFLEtBRGU7QUFFeEJDLFFBQUFBLFNBQVMsRUFBRSxDQUZhO0FBR3hCQyxRQUFBQSxTQUFTLEVBQUU7QUFIYSxPQUExQjtBQU1BLFlBQU1DLEdBQUcsR0FBR0MsSUFBSSxDQUFDQyxHQUFMLENBQVNSLElBQUksQ0FBQ1MsTUFBZCxFQUFzQlIsTUFBTSxHQUFHLEdBQS9CLENBQVosQ0FQMkQsQ0FTM0Q7O0FBQ0EsV0FBSyxJQUFJUyxDQUFDLEdBQUdULE1BQWIsRUFBcUJTLENBQUMsR0FBR0osR0FBekIsRUFBOEJJLENBQUMsRUFBL0IsRUFBbUM7QUFDakMsWUFBSWhDLE1BQU0sQ0FBQ2lDLFFBQVAsQ0FBZ0JYLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLENBQWhCLENBQUosRUFBcUM7QUFDbkNSLFVBQUFBLE1BQU0sQ0FBQ0UsU0FBUDtBQUNELFNBRkQsTUFFTztBQUNMLGNBQUlGLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUF2QixFQUEwQjtBQUN4QkYsWUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0Q7O0FBQ0QsaUJBQU9ELE1BQVA7QUFDRDtBQUNGLE9BbkIwRCxDQW9CM0Q7QUFDQTtBQUNBO0FBQ0E7OztBQUNBLFVBQUlBLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUF2QixFQUEwQjtBQUN4QkYsUUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0Q7O0FBRUQsYUFBT0QsTUFBUDtBQUNELEtBN0JELEVBOEJHSCxPQTlCSCxDQThCV2pCLGlCQUFpQixDQUFDSSxjQTlCN0IsRUE4QjZDLENBQUNjLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUMzRCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCO0FBTUEsVUFBSVEsVUFBSjtBQUNBLFVBQUlDLG9CQUE2QixHQUFHLEtBQXBDO0FBRUEsVUFBSUMsSUFBSSxHQUFHZixJQUFJLENBQUNZLE1BQUwsQ0FBWVgsTUFBWixDQUFYOztBQUNBLFVBQUljLElBQUksSUFBSSxJQUFaLEVBQWtCO0FBQ2hCRixRQUFBQSxVQUFVLEdBQUdFLElBQWI7QUFDRCxPQUZELE1BRU8sSUFBSUEsSUFBSSxJQUFJLEdBQVosRUFBaUI7QUFDdEJGLFFBQUFBLFVBQVUsR0FBR0UsSUFBYjtBQUNELE9BRk0sTUFFQSxJQUFJQSxJQUFJLElBQUksR0FBWixFQUFpQjtBQUN0QkYsUUFBQUEsVUFBVSxHQUFHRSxJQUFiO0FBQ0QsT0FGTSxNQUVBO0FBQ0wsZUFBT2IsTUFBUDtBQUNEOztBQUNEQSxNQUFBQSxNQUFNLENBQUNFLFNBQVA7O0FBRUEsV0FBSyxJQUFJTSxDQUFDLEdBQUdULE1BQU0sR0FBRyxDQUF0QixFQUF5QlMsQ0FBQyxHQUFHVixJQUFJLENBQUNTLE1BQWxDLEVBQTBDQyxDQUFDLEVBQTNDLEVBQStDO0FBQzdDSyxRQUFBQSxJQUFJLEdBQUdmLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLENBQVA7O0FBQ0EsWUFBSUssSUFBSSxJQUFJRixVQUFaLEVBQXdCO0FBQ3RCLGNBQUksQ0FBQ0Msb0JBQUwsRUFBMkI7QUFDekJaLFlBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNBRCxZQUFBQSxNQUFNLENBQUNFLFNBQVA7QUFDQSxtQkFBT0YsTUFBUDtBQUNEO0FBQ0YsU0FORCxNQU1PLElBQUlhLElBQUksSUFBSSxJQUFaLEVBQWtCO0FBQ3ZCRCxVQUFBQSxvQkFBb0IsR0FBRyxJQUF2QjtBQUNELFNBRk0sTUFFQTtBQUNMLGNBQUlBLG9CQUFKLEVBQTBCQSxvQkFBb0IsR0FBRyxLQUF2QjtBQUMzQjs7QUFDRFosUUFBQUEsTUFBTSxDQUFDRSxTQUFQO0FBQ0Q7O0FBRUQsYUFBT0YsTUFBUDtBQUNELEtBckVILEVBc0VHSCxPQXRFSCxDQXNFV2pCLGlCQUFpQixDQUFDTSxjQXRFN0IsRUFzRTZDLENBQUNZLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUMzRCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCO0FBTUEsWUFBTUMsR0FBRyxHQUFHQyxJQUFJLENBQUNDLEdBQUwsQ0FBU1IsSUFBSSxDQUFDUyxNQUFkLEVBQXNCUixNQUFNLEdBQUcsR0FBL0IsQ0FBWixDQVAyRCxDQVMzRDs7QUFDQSxXQUFLLElBQUlTLENBQUMsR0FBR1QsTUFBYixFQUFxQlMsQ0FBQyxHQUFHSixHQUF6QixFQUE4QkksQ0FBQyxFQUEvQixFQUFtQztBQUNqQyxZQUFJcEMsT0FBTyxDQUFDcUMsUUFBUixDQUFpQlgsSUFBSSxDQUFDWSxNQUFMLENBQVlGLENBQVosQ0FBakIsQ0FBSixFQUFzQztBQUNwQ1IsVUFBQUEsTUFBTSxDQUFDRSxTQUFQO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsY0FBSUYsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixZQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxpQkFBT0QsTUFBUDtBQUNEO0FBQ0YsT0FuQjBELENBb0IzRDtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0EsVUFBSUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFFRCxhQUFPRCxNQUFQO0FBQ0QsS0FuR0gsRUFvR0dILE9BcEdILENBb0dXakIsaUJBQWlCLENBQUNRLFFBcEc3QixFQW9HdUMsQ0FBQ1UsSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQ3JELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7O0FBS0EsVUFBSTlCLEdBQUcsQ0FBQ29DLFFBQUosQ0FBYVgsSUFBSSxDQUFDWSxNQUFMLENBQVlYLE1BQVosQ0FBYixDQUFKLEVBQXVDO0FBQ3JDQyxRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDQUQsUUFBQUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQW5CO0FBQ0Q7O0FBQ0QsYUFBT0YsTUFBUDtBQUNELEtBL0dILEVBZ0hHSCxPQWhISCxDQWdIV2pCLGlCQUFpQixDQUFDVSxPQWhIN0IsRUFnSHNDLENBQUNRLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUNwRCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCOztBQUtBLFVBQUl4QixRQUFRLENBQUM4QixRQUFULENBQWtCWCxJQUFJLENBQUNZLE1BQUwsQ0FBWVgsTUFBWixDQUFsQixDQUFKLEVBQTRDO0FBQzFDQyxRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDQUQsUUFBQUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQW5CO0FBQ0Q7O0FBQ0QsYUFBT0YsTUFBUDtBQUNELEtBM0hILEVBNEhHSCxPQTVISCxDQTRIV2pCLGlCQUFpQixDQUFDZSxXQTVIN0IsRUE0SDBDLENBQUNHLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUN4RCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCOztBQUtBLFVBQUl6QixLQUFLLENBQUMrQixRQUFOLENBQWVYLElBQUksQ0FBQ1ksTUFBTCxDQUFZWCxNQUFaLENBQWYsQ0FBSixFQUF5QztBQUN2Q0MsUUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0FELFFBQUFBLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUFuQjtBQUNEOztBQUNELGFBQU9GLE1BQVA7QUFDRCxLQXZJSCxFQXdJR0gsT0F4SUgsQ0F3SVdqQixpQkFBaUIsQ0FBQ1csVUF4STdCLEVBd0l5QyxDQUFDTyxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDdkQsVUFBSUMsTUFBbUIsR0FBRztBQUN4QkMsUUFBQUEsT0FBTyxFQUFFLEtBRGU7QUFFeEJDLFFBQUFBLFNBQVMsRUFBRSxDQUZhO0FBR3hCQyxRQUFBQSxTQUFTLEVBQUU7QUFIYSxPQUExQjs7QUFLQSxVQUFJMUIsS0FBSyxDQUFDZ0MsUUFBTixDQUFlWCxJQUFJLENBQUNZLE1BQUwsQ0FBWVgsTUFBWixDQUFmLENBQUosRUFBeUM7QUFDdkNDLFFBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNBRCxRQUFBQSxNQUFNLENBQUNFLFNBQVAsR0FBbUIsQ0FBbkI7QUFDRDs7QUFDRCxhQUFPRixNQUFQO0FBQ0QsS0FuSkgsRUFvSkdILE9BcEpILENBb0pXakIsaUJBQWlCLENBQUNhLFVBcEo3QixFQW9KeUMsQ0FBQ0ssSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQ3ZELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7O0FBTUEsV0FBSyxJQUFJSyxDQUFDLEdBQUdULE1BQWIsRUFBcUJTLENBQUMsR0FBR1YsSUFBSSxDQUFDUyxNQUE5QixFQUFzQ0MsQ0FBQyxFQUF2QyxFQUEyQztBQUN6QyxZQUFJbEMsRUFBRSxDQUFDbUMsUUFBSCxDQUFZWCxJQUFJLENBQUNZLE1BQUwsQ0FBWUYsQ0FBWixDQUFaLENBQUosRUFBaUM7QUFDL0I7QUFDQSxjQUFJVixJQUFJLENBQUNZLE1BQUwsQ0FBWUYsQ0FBWixLQUFrQmpDLEVBQXRCLEVBQTBCO0FBQ3hCeUIsWUFBQUEsTUFBTSxDQUFDRyxTQUFQO0FBQ0Q7O0FBQ0RILFVBQUFBLE1BQU0sQ0FBQ0UsU0FBUDtBQUNELFNBTkQsTUFNTztBQUNMLGNBQUlGLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUF2QixFQUEwQjtBQUN4QkYsWUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0Q7O0FBQ0QsaUJBQU9ELE1BQVA7QUFDRDtBQUNGOztBQUNELFVBQUlBLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUF2QixFQUEwQjtBQUN4QkYsUUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0Q7O0FBQ0QsYUFBT0QsTUFBUDtBQUNELEtBN0tIO0FBOEtEOztBQTFMNEMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFNjYW5uZXIsIFNjYW5uZXJEYXRhIH0gZnJvbSBcIi4uL3Rva2VuaXplci9zY2FubmVyLmpzXCI7XG5pbXBvcnQgeyBUb2tlbiB9IGZyb20gXCIuLi90b2tlbml6ZXIvdG9rZW4uanNcIjtcblxuY29uc3QgbnVtYmVycyA9IFwiMDEyMzQ1Njc4OVwiO1xuY29uc3Qgb3BzID0gXCItKy8qJT1cIjtcbmNvbnN0IHdzID0gXCIgXFxuXCI7XG5jb25zdCBubCA9IFwiXFxuXCI7XG5jb25zdCBpZGVudHMgPSBcImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVpfXCI7XG5jb25zdCB0ZXJtcyA9IFwiOjsuLFwiXG5jb25zdCBwYXJlbiA9IFwiKClcIjtcbmNvbnN0IGJyYWNrZXRzID0gXCJ7W119XCI7XG5cbmV4cG9ydCBjbGFzcyBUeXBlU2NyaXB0U2Nhbm5lciBleHRlbmRzIFNjYW5uZXIge1xuICBzdGF0aWMgSURFTlRJRklFUjogc3RyaW5nID0gVG9rZW4uVFlQRV9JREVOVElGSUVSO1xuICBzdGF0aWMgS0VZV09SRDogc3RyaW5nID0gXCJrZXl3XCI7XG4gIHN0YXRpYyBTVFJJTkdfTElURVJBTDogc3RyaW5nID0gVG9rZW4uVFlQRV9TVFJJTkdfTElURVJBTDtcbiAgc3RhdGljIE5VTUJFUl9MSVRFUkFMOiBzdHJpbmcgPSBUb2tlbi5UWVBFX05VTUJFUl9MSVRFUkFMO1xuICBzdGF0aWMgT1BFUkFUT1I6IHN0cmluZyA9IFRva2VuLlRZUEVfT1BFUkFUT1I7XG4gIHN0YXRpYyBCUkFDS0VUOiBzdHJpbmcgPSBcImJyYWtcIjtcbiAgc3RhdGljIFRFUk1JTkFUT1I6IHN0cmluZyA9IFRva2VuLlRZUEVfVEVSTUlOQVRPUjtcbiAgc3RhdGljIFdISVRFU1BBQ0U6IHN0cmluZyA9IFRva2VuLlRZUEVfV0hJVEVTUEFDRTtcbiAgc3RhdGljIFBBUkVOVEhFU0lTOiBzdHJpbmcgPSBcInBhcmVcIjtcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmFkZFBhc3MoVHlwZVNjcmlwdFNjYW5uZXIuSURFTlRJRklFUiwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgfTtcblxuICAgICAgY29uc3QgbWF4ID0gTWF0aC5taW4oZGF0YS5sZW5ndGgsIG9mZnNldCArIDMwOSk7XG5cbiAgICAgIC8vbm8gbmVlZCB0byBzY2FuIHBhc3Qgd2hhdCB3ZSBjYW4ndCBoYW5kbGUsIHVzZSBvbmx5IDMwOSBtYXggY2hhcnNcbiAgICAgIGZvciAobGV0IGkgPSBvZmZzZXQ7IGkgPCBtYXg7IGkrKykge1xuICAgICAgICBpZiAoaWRlbnRzLmluY2x1ZGVzKGRhdGEuY2hhckF0KGkpKSkge1xuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgLy8gaWYgKG51bWJlcnMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0K21heCkpKSB7XG4gICAgICAvLyAgIHJlc3VsdC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAvLyAgIHJlc3VsdC5lcnJvciA9IGB0b28gbWFueSBudW1iZXIgY2hhcnMgZm9yIGEgbGl0ZXJhbDogJHtkYXRhLnN1YnN0cmluZyhvZmZzZXQsIG9mZnNldCttYXgpfWA7XG4gICAgICAvLyB9XG4gICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5TVFJJTkdfTElURVJBTCwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG5cbiAgICAgICAgbGV0IG1hdGNoUXVvdGU6IHN0cmluZztcbiAgICAgICAgbGV0IGlnbm9yZU5leHRNYXRjaFF1b3RlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICAgICAgbGV0IGNoYXIgPSBkYXRhLmNoYXJBdChvZmZzZXQpO1xuICAgICAgICBpZiAoY2hhciA9PSBcIlxcXCJcIikge1xuICAgICAgICAgIG1hdGNoUXVvdGUgPSBjaGFyO1xuICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT0gXCInXCIpIHtcbiAgICAgICAgICBtYXRjaFF1b3RlID0gY2hhcjtcbiAgICAgICAgfSBlbHNlIGlmIChjaGFyID09IFwiYFwiKSB7XG4gICAgICAgICAgbWF0Y2hRdW90ZSA9IGNoYXI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfVxuICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IG9mZnNldCArIDE7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgY2hhciA9IGRhdGEuY2hhckF0KGkpO1xuICAgICAgICAgIGlmIChjaGFyID09IG1hdGNoUXVvdGUpIHtcbiAgICAgICAgICAgIGlmICghaWdub3JlTmV4dE1hdGNoUXVvdGUpIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09IFwiXFxcXFwiKSB7XG4gICAgICAgICAgICBpZ25vcmVOZXh0TWF0Y2hRdW90ZSA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChpZ25vcmVOZXh0TWF0Y2hRdW90ZSkgaWdub3JlTmV4dE1hdGNoUXVvdGUgPSBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5OVU1CRVJfTElURVJBTCwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgbWF4ID0gTWF0aC5taW4oZGF0YS5sZW5ndGgsIG9mZnNldCArIDMwOSk7XG5cbiAgICAgICAgLy9ubyBuZWVkIHRvIHNjYW4gcGFzdCB3aGF0IHdlIGNhbid0IGhhbmRsZSwgdXNlIG9ubHkgMzA5IG1heCBjaGFyc1xuICAgICAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgbWF4OyBpKyspIHtcbiAgICAgICAgICBpZiAobnVtYmVycy5pbmNsdWRlcyhkYXRhLmNoYXJBdChpKSkpIHtcbiAgICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIGlmIChudW1iZXJzLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCttYXgpKSkge1xuICAgICAgICAvLyAgIHJlc3VsdC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIC8vICAgcmVzdWx0LmVycm9yID0gYHRvbyBtYW55IG51bWJlciBjaGFycyBmb3IgYSBsaXRlcmFsOiAke2RhdGEuc3Vic3RyaW5nKG9mZnNldCwgb2Zmc2V0K21heCl9YDtcbiAgICAgICAgLy8gfVxuICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLk9QRVJBVE9SLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG9wcy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLkJSQUNLRVQsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAoYnJhY2tldHMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5QQVJFTlRIRVNJUywgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG4gICAgICAgIGlmIChwYXJlbi5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQpKSkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzID0gMTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSlcbiAgICAgIC5hZGRQYXNzKFR5cGVTY3JpcHRTY2FubmVyLlRFUk1JTkFUT1IsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAodGVybXMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhUeXBlU2NyaXB0U2Nhbm5lci5XSElURVNQQUNFLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcblxuICAgICAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGlmICh3cy5pbmNsdWRlcyhkYXRhLmNoYXJBdChpKSkpIHtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBXUzogXCIke2RhdGEuY2hhckF0KGkpfVwiYCk7XG4gICAgICAgICAgICBpZiAoZGF0YS5jaGFyQXQoaSkgPT0gbmwpIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnJlYWRMaW5lcysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnJlYWRDaGFycyA+IDApIHtcbiAgICAgICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KTtcbiAgfVxufVxuIl19