import Scanner from "../scanner.js";
import Token from "../token.js";
const numbers = "0123456789";
const ops = "-+/*%=";
const ws = " \n";
const nl = "\n";
const idents = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_";
const terms = ";.,";
const paren = "()";
const brackets = "{[]}";
export default class JavaScriptScanner extends Scanner {
  static IDENTIFIER = Token.TYPE_IDENTIFIER;
  static STRING_LITERAL = Token.TYPE_STRING_LITERAL;
  static NUMBER_LITERAL = Token.TYPE_NUMBER_LITERAL;
  static OPERATOR = Token.TYPE_OPERATOR;
  static BRACKET = "brak";
  static TERMINATOR = Token.TYPE_TERMINATOR;
  static WHITESPACE = Token.TYPE_WHITESPACE;
  static PARENTHESIS = "pare";

  constructor() {
    super();
    this.addPass(JavaScriptScanner.IDENTIFIER, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (idents.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(JavaScriptScanner.STRING_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      let matchQuote;
      let ignoreNextMatchQuote = false;
      let char = data.charAt(offset);

      if (char == "\"") {
        matchQuote = char;
      } else if (char == "'") {
        matchQuote = char;
      } else if (char == "`") {
        matchQuote = char;
      } else {
        return result;
      }

      result.readChars++;

      for (let i = offset + 1; i < data.length; i++) {
        char = data.charAt(i);

        if (char == matchQuote) {
          if (!ignoreNextMatchQuote) {
            result.success = true;
            result.readChars++;
            return result;
          }
        } else if (char == "\\") {
          ignoreNextMatchQuote = true;
        } else {
          if (ignoreNextMatchQuote) ignoreNextMatchQuote = false;
        }

        result.readChars++;
      }

      return result;
    }).addPass(JavaScriptScanner.NUMBER_LITERAL, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };
      const max = Math.min(data.length, offset + 309); //no need to scan past what we can't handle, use only 309 max chars

      for (let i = offset; i < max; i++) {
        if (numbers.includes(data.charAt(i))) {
          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      } // if (numbers.includes(data.charAt(offset+max))) {
      //   result.success = false;
      //   result.error = `too many number chars for a literal: ${data.substring(offset, offset+max)}`;
      // }


      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    }).addPass(JavaScriptScanner.OPERATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (ops.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(JavaScriptScanner.BRACKET, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (brackets.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(JavaScriptScanner.PARENTHESIS, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (paren.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(JavaScriptScanner.TERMINATOR, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      if (terms.includes(data.charAt(offset))) {
        result.success = true;
        result.readChars = 1;
      }

      return result;
    }).addPass(JavaScriptScanner.WHITESPACE, (data, offset) => {
      let result = {
        success: false,
        readChars: 0,
        readLines: 0
      };

      for (let i = offset; i < data.length; i++) {
        if (ws.includes(data.charAt(i))) {
          // console.log(`WS: "${data.charAt(i)}"`);
          if (data.charAt(i) == nl) {
            result.readLines++;
          }

          result.readChars++;
        } else {
          if (result.readChars > 0) {
            result.success = true;
          }

          return result;
        }
      }

      if (result.readChars > 0) {
        result.success = true;
      }

      return result;
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90b2tlbml6ZXIvbGFuZ3MvamF2YXNjcmlwdC50cyJdLCJuYW1lcyI6WyJTY2FubmVyIiwiVG9rZW4iLCJudW1iZXJzIiwib3BzIiwid3MiLCJubCIsImlkZW50cyIsInRlcm1zIiwicGFyZW4iLCJicmFja2V0cyIsIkphdmFTY3JpcHRTY2FubmVyIiwiSURFTlRJRklFUiIsIlRZUEVfSURFTlRJRklFUiIsIlNUUklOR19MSVRFUkFMIiwiVFlQRV9TVFJJTkdfTElURVJBTCIsIk5VTUJFUl9MSVRFUkFMIiwiVFlQRV9OVU1CRVJfTElURVJBTCIsIk9QRVJBVE9SIiwiVFlQRV9PUEVSQVRPUiIsIkJSQUNLRVQiLCJURVJNSU5BVE9SIiwiVFlQRV9URVJNSU5BVE9SIiwiV0hJVEVTUEFDRSIsIlRZUEVfV0hJVEVTUEFDRSIsIlBBUkVOVEhFU0lTIiwiY29uc3RydWN0b3IiLCJhZGRQYXNzIiwiZGF0YSIsIm9mZnNldCIsInJlc3VsdCIsInN1Y2Nlc3MiLCJyZWFkQ2hhcnMiLCJyZWFkTGluZXMiLCJtYXgiLCJNYXRoIiwibWluIiwibGVuZ3RoIiwiaSIsImluY2x1ZGVzIiwiY2hhckF0IiwibWF0Y2hRdW90ZSIsImlnbm9yZU5leHRNYXRjaFF1b3RlIiwiY2hhciJdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBT0EsT0FBUCxNQUFxQyxlQUFyQztBQUNBLE9BQU9DLEtBQVAsTUFBa0IsYUFBbEI7QUFFQSxNQUFNQyxPQUFPLEdBQUcsWUFBaEI7QUFDQSxNQUFNQyxHQUFHLEdBQUcsUUFBWjtBQUNBLE1BQU1DLEVBQUUsR0FBRyxLQUFYO0FBQ0EsTUFBTUMsRUFBRSxHQUFHLElBQVg7QUFDQSxNQUFNQyxNQUFNLEdBQUcsdURBQWY7QUFDQSxNQUFNQyxLQUFLLEdBQUcsS0FBZDtBQUNBLE1BQU1DLEtBQUssR0FBRyxJQUFkO0FBQ0EsTUFBTUMsUUFBUSxHQUFHLE1BQWpCO0FBRUEsZUFBZSxNQUFNQyxpQkFBTixTQUFnQ1YsT0FBaEMsQ0FBd0M7QUFDckQsU0FBT1csVUFBUCxHQUE0QlYsS0FBSyxDQUFDVyxlQUFsQztBQUNBLFNBQU9DLGNBQVAsR0FBZ0NaLEtBQUssQ0FBQ2EsbUJBQXRDO0FBQ0EsU0FBT0MsY0FBUCxHQUFnQ2QsS0FBSyxDQUFDZSxtQkFBdEM7QUFDQSxTQUFPQyxRQUFQLEdBQTBCaEIsS0FBSyxDQUFDaUIsYUFBaEM7QUFDQSxTQUFPQyxPQUFQLEdBQXlCLE1BQXpCO0FBQ0EsU0FBT0MsVUFBUCxHQUE0Qm5CLEtBQUssQ0FBQ29CLGVBQWxDO0FBQ0EsU0FBT0MsVUFBUCxHQUE0QnJCLEtBQUssQ0FBQ3NCLGVBQWxDO0FBQ0EsU0FBT0MsV0FBUCxHQUE2QixNQUE3Qjs7QUFDQUMsRUFBQUEsV0FBVyxHQUFHO0FBQ1o7QUFDQSxTQUFLQyxPQUFMLENBQWFoQixpQkFBaUIsQ0FBQ0MsVUFBL0IsRUFBMkMsQ0FBQ2dCLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUMzRCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCO0FBTUEsWUFBTUMsR0FBRyxHQUFHQyxJQUFJLENBQUNDLEdBQUwsQ0FBU1IsSUFBSSxDQUFDUyxNQUFkLEVBQXNCUixNQUFNLEdBQUcsR0FBL0IsQ0FBWixDQVAyRCxDQVMzRDs7QUFDQSxXQUFLLElBQUlTLENBQUMsR0FBR1QsTUFBYixFQUFxQlMsQ0FBQyxHQUFHSixHQUF6QixFQUE4QkksQ0FBQyxFQUEvQixFQUFtQztBQUNqQyxZQUFJL0IsTUFBTSxDQUFDZ0MsUUFBUCxDQUFnQlgsSUFBSSxDQUFDWSxNQUFMLENBQVlGLENBQVosQ0FBaEIsQ0FBSixFQUFxQztBQUNuQ1IsVUFBQUEsTUFBTSxDQUFDRSxTQUFQO0FBQ0QsU0FGRCxNQUVPO0FBQ0wsY0FBSUYsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixZQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxpQkFBT0QsTUFBUDtBQUNEO0FBQ0YsT0FuQjBELENBb0IzRDtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0EsVUFBSUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFFRCxhQUFPRCxNQUFQO0FBQ0QsS0E3QkQsRUE4QkdILE9BOUJILENBOEJXaEIsaUJBQWlCLENBQUNHLGNBOUI3QixFQThCNkMsQ0FBQ2MsSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQzNELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7QUFNQSxVQUFJUSxVQUFKO0FBQ0EsVUFBSUMsb0JBQTZCLEdBQUcsS0FBcEM7QUFFQSxVQUFJQyxJQUFJLEdBQUdmLElBQUksQ0FBQ1ksTUFBTCxDQUFZWCxNQUFaLENBQVg7O0FBQ0EsVUFBSWMsSUFBSSxJQUFJLElBQVosRUFBa0I7QUFDaEJGLFFBQUFBLFVBQVUsR0FBR0UsSUFBYjtBQUNELE9BRkQsTUFFTyxJQUFJQSxJQUFJLElBQUksR0FBWixFQUFpQjtBQUN0QkYsUUFBQUEsVUFBVSxHQUFHRSxJQUFiO0FBQ0QsT0FGTSxNQUVBLElBQUlBLElBQUksSUFBSSxHQUFaLEVBQWlCO0FBQ3RCRixRQUFBQSxVQUFVLEdBQUdFLElBQWI7QUFDRCxPQUZNLE1BRUE7QUFDTCxlQUFPYixNQUFQO0FBQ0Q7O0FBQ0RBLE1BQUFBLE1BQU0sQ0FBQ0UsU0FBUDs7QUFFQSxXQUFLLElBQUlNLENBQUMsR0FBR1QsTUFBTSxHQUFHLENBQXRCLEVBQXlCUyxDQUFDLEdBQUdWLElBQUksQ0FBQ1MsTUFBbEMsRUFBMENDLENBQUMsRUFBM0MsRUFBK0M7QUFDN0NLLFFBQUFBLElBQUksR0FBR2YsSUFBSSxDQUFDWSxNQUFMLENBQVlGLENBQVosQ0FBUDs7QUFDQSxZQUFJSyxJQUFJLElBQUlGLFVBQVosRUFBd0I7QUFDdEIsY0FBSSxDQUFDQyxvQkFBTCxFQUEyQjtBQUN6QlosWUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0FELFlBQUFBLE1BQU0sQ0FBQ0UsU0FBUDtBQUNBLG1CQUFPRixNQUFQO0FBQ0Q7QUFDRixTQU5ELE1BTU8sSUFBSWEsSUFBSSxJQUFJLElBQVosRUFBa0I7QUFDdkJELFVBQUFBLG9CQUFvQixHQUFHLElBQXZCO0FBQ0QsU0FGTSxNQUVBO0FBQ0wsY0FBSUEsb0JBQUosRUFBMEJBLG9CQUFvQixHQUFHLEtBQXZCO0FBQzNCOztBQUNEWixRQUFBQSxNQUFNLENBQUNFLFNBQVA7QUFDRDs7QUFFRCxhQUFPRixNQUFQO0FBQ0QsS0FyRUgsRUFzRUdILE9BdEVILENBc0VXaEIsaUJBQWlCLENBQUNLLGNBdEU3QixFQXNFNkMsQ0FBQ1ksSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQzNELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7QUFNQSxZQUFNQyxHQUFHLEdBQUdDLElBQUksQ0FBQ0MsR0FBTCxDQUFTUixJQUFJLENBQUNTLE1BQWQsRUFBc0JSLE1BQU0sR0FBRyxHQUEvQixDQUFaLENBUDJELENBUzNEOztBQUNBLFdBQUssSUFBSVMsQ0FBQyxHQUFHVCxNQUFiLEVBQXFCUyxDQUFDLEdBQUdKLEdBQXpCLEVBQThCSSxDQUFDLEVBQS9CLEVBQW1DO0FBQ2pDLFlBQUluQyxPQUFPLENBQUNvQyxRQUFSLENBQWlCWCxJQUFJLENBQUNZLE1BQUwsQ0FBWUYsQ0FBWixDQUFqQixDQUFKLEVBQXNDO0FBQ3BDUixVQUFBQSxNQUFNLENBQUNFLFNBQVA7QUFDRCxTQUZELE1BRU87QUFDTCxjQUFJRixNQUFNLENBQUNFLFNBQVAsR0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEJGLFlBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNEOztBQUNELGlCQUFPRCxNQUFQO0FBQ0Q7QUFDRixPQW5CMEQsQ0FvQjNEO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxVQUFJQSxNQUFNLENBQUNFLFNBQVAsR0FBbUIsQ0FBdkIsRUFBMEI7QUFDeEJGLFFBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNEOztBQUVELGFBQU9ELE1BQVA7QUFDRCxLQW5HSCxFQW9HR0gsT0FwR0gsQ0FvR1doQixpQkFBaUIsQ0FBQ08sUUFwRzdCLEVBb0d1QyxDQUFDVSxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDckQsVUFBSUMsTUFBbUIsR0FBRztBQUN4QkMsUUFBQUEsT0FBTyxFQUFFLEtBRGU7QUFFeEJDLFFBQUFBLFNBQVMsRUFBRSxDQUZhO0FBR3hCQyxRQUFBQSxTQUFTLEVBQUU7QUFIYSxPQUExQjs7QUFLQSxVQUFJN0IsR0FBRyxDQUFDbUMsUUFBSixDQUFhWCxJQUFJLENBQUNZLE1BQUwsQ0FBWVgsTUFBWixDQUFiLENBQUosRUFBdUM7QUFDckNDLFFBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNBRCxRQUFBQSxNQUFNLENBQUNFLFNBQVAsR0FBbUIsQ0FBbkI7QUFDRDs7QUFDRCxhQUFPRixNQUFQO0FBQ0QsS0EvR0gsRUFnSEdILE9BaEhILENBZ0hXaEIsaUJBQWlCLENBQUNTLE9BaEg3QixFQWdIc0MsQ0FBQ1EsSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQ3BELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7O0FBS0EsVUFBSXZCLFFBQVEsQ0FBQzZCLFFBQVQsQ0FBa0JYLElBQUksQ0FBQ1ksTUFBTCxDQUFZWCxNQUFaLENBQWxCLENBQUosRUFBNEM7QUFDMUNDLFFBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQixJQUFqQjtBQUNBRCxRQUFBQSxNQUFNLENBQUNFLFNBQVAsR0FBbUIsQ0FBbkI7QUFDRDs7QUFDRCxhQUFPRixNQUFQO0FBQ0QsS0EzSEgsRUE0SEdILE9BNUhILENBNEhXaEIsaUJBQWlCLENBQUNjLFdBNUg3QixFQTRIMEMsQ0FBQ0csSUFBRCxFQUFPQyxNQUFQLEtBQWtCO0FBQ3hELFVBQUlDLE1BQW1CLEdBQUc7QUFDeEJDLFFBQUFBLE9BQU8sRUFBRSxLQURlO0FBRXhCQyxRQUFBQSxTQUFTLEVBQUUsQ0FGYTtBQUd4QkMsUUFBQUEsU0FBUyxFQUFFO0FBSGEsT0FBMUI7O0FBS0EsVUFBSXhCLEtBQUssQ0FBQzhCLFFBQU4sQ0FBZVgsSUFBSSxDQUFDWSxNQUFMLENBQVlYLE1BQVosQ0FBZixDQUFKLEVBQXlDO0FBQ3ZDQyxRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDQUQsUUFBQUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQW5CO0FBQ0Q7O0FBQ0QsYUFBT0YsTUFBUDtBQUNELEtBdklILEVBd0lHSCxPQXhJSCxDQXdJV2hCLGlCQUFpQixDQUFDVSxVQXhJN0IsRUF3SXlDLENBQUNPLElBQUQsRUFBT0MsTUFBUCxLQUFrQjtBQUN2RCxVQUFJQyxNQUFtQixHQUFHO0FBQ3hCQyxRQUFBQSxPQUFPLEVBQUUsS0FEZTtBQUV4QkMsUUFBQUEsU0FBUyxFQUFFLENBRmE7QUFHeEJDLFFBQUFBLFNBQVMsRUFBRTtBQUhhLE9BQTFCOztBQUtBLFVBQUl6QixLQUFLLENBQUMrQixRQUFOLENBQWVYLElBQUksQ0FBQ1ksTUFBTCxDQUFZWCxNQUFaLENBQWYsQ0FBSixFQUF5QztBQUN2Q0MsUUFBQUEsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLElBQWpCO0FBQ0FELFFBQUFBLE1BQU0sQ0FBQ0UsU0FBUCxHQUFtQixDQUFuQjtBQUNEOztBQUNELGFBQU9GLE1BQVA7QUFDRCxLQW5KSCxFQW9KR0gsT0FwSkgsQ0FvSldoQixpQkFBaUIsQ0FBQ1ksVUFwSjdCLEVBb0p5QyxDQUFDSyxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDdkQsVUFBSUMsTUFBbUIsR0FBRztBQUN4QkMsUUFBQUEsT0FBTyxFQUFFLEtBRGU7QUFFeEJDLFFBQUFBLFNBQVMsRUFBRSxDQUZhO0FBR3hCQyxRQUFBQSxTQUFTLEVBQUU7QUFIYSxPQUExQjs7QUFNQSxXQUFLLElBQUlLLENBQUMsR0FBR1QsTUFBYixFQUFxQlMsQ0FBQyxHQUFHVixJQUFJLENBQUNTLE1BQTlCLEVBQXNDQyxDQUFDLEVBQXZDLEVBQTJDO0FBQ3pDLFlBQUlqQyxFQUFFLENBQUNrQyxRQUFILENBQVlYLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLENBQVosQ0FBSixFQUFpQztBQUMvQjtBQUNBLGNBQUlWLElBQUksQ0FBQ1ksTUFBTCxDQUFZRixDQUFaLEtBQWtCaEMsRUFBdEIsRUFBMEI7QUFDeEJ3QixZQUFBQSxNQUFNLENBQUNHLFNBQVA7QUFDRDs7QUFDREgsVUFBQUEsTUFBTSxDQUFDRSxTQUFQO0FBQ0QsU0FORCxNQU1PO0FBQ0wsY0FBSUYsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixZQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxpQkFBT0QsTUFBUDtBQUNEO0FBQ0Y7O0FBQ0QsVUFBSUEsTUFBTSxDQUFDRSxTQUFQLEdBQW1CLENBQXZCLEVBQTBCO0FBQ3hCRixRQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUIsSUFBakI7QUFDRDs7QUFDRCxhQUFPRCxNQUFQO0FBQ0QsS0E3S0g7QUE4S0Q7O0FBekxvRCIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IFNjYW5uZXIsIHsgU2Nhbm5lckRhdGEgfSBmcm9tIFwiLi4vc2Nhbm5lci5qc1wiO1xuaW1wb3J0IFRva2VuIGZyb20gXCIuLi90b2tlbi5qc1wiO1xuXG5jb25zdCBudW1iZXJzID0gXCIwMTIzNDU2Nzg5XCI7XG5jb25zdCBvcHMgPSBcIi0rLyolPVwiO1xuY29uc3Qgd3MgPSBcIiBcXG5cIjtcbmNvbnN0IG5sID0gXCJcXG5cIjtcbmNvbnN0IGlkZW50cyA9IFwiYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXpBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWl9cIjtcbmNvbnN0IHRlcm1zID0gXCI7LixcIlxuY29uc3QgcGFyZW4gPSBcIigpXCI7XG5jb25zdCBicmFja2V0cyA9IFwie1tdfVwiO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBKYXZhU2NyaXB0U2Nhbm5lciBleHRlbmRzIFNjYW5uZXIge1xuICBzdGF0aWMgSURFTlRJRklFUjogc3RyaW5nID0gVG9rZW4uVFlQRV9JREVOVElGSUVSO1xuICBzdGF0aWMgU1RSSU5HX0xJVEVSQUw6IHN0cmluZyA9IFRva2VuLlRZUEVfU1RSSU5HX0xJVEVSQUw7XG4gIHN0YXRpYyBOVU1CRVJfTElURVJBTDogc3RyaW5nID0gVG9rZW4uVFlQRV9OVU1CRVJfTElURVJBTDtcbiAgc3RhdGljIE9QRVJBVE9SOiBzdHJpbmcgPSBUb2tlbi5UWVBFX09QRVJBVE9SO1xuICBzdGF0aWMgQlJBQ0tFVDogc3RyaW5nID0gXCJicmFrXCI7XG4gIHN0YXRpYyBURVJNSU5BVE9SOiBzdHJpbmcgPSBUb2tlbi5UWVBFX1RFUk1JTkFUT1I7XG4gIHN0YXRpYyBXSElURVNQQUNFOiBzdHJpbmcgPSBUb2tlbi5UWVBFX1dISVRFU1BBQ0U7XG4gIHN0YXRpYyBQQVJFTlRIRVNJUzogc3RyaW5nID0gXCJwYXJlXCI7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5hZGRQYXNzKEphdmFTY3JpcHRTY2FubmVyLklERU5USUZJRVIsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgIH07XG5cbiAgICAgIGNvbnN0IG1heCA9IE1hdGgubWluKGRhdGEubGVuZ3RoLCBvZmZzZXQgKyAzMDkpO1xuXG4gICAgICAvL25vIG5lZWQgdG8gc2NhbiBwYXN0IHdoYXQgd2UgY2FuJ3QgaGFuZGxlLCB1c2Ugb25seSAzMDkgbWF4IGNoYXJzXG4gICAgICBmb3IgKGxldCBpID0gb2Zmc2V0OyBpIDwgbWF4OyBpKyspIHtcbiAgICAgICAgaWYgKGlkZW50cy5pbmNsdWRlcyhkYXRhLmNoYXJBdChpKSkpIHtcbiAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIC8vIGlmIChudW1iZXJzLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCttYXgpKSkge1xuICAgICAgLy8gICByZXN1bHQuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgLy8gICByZXN1bHQuZXJyb3IgPSBgdG9vIG1hbnkgbnVtYmVyIGNoYXJzIGZvciBhIGxpdGVyYWw6ICR7ZGF0YS5zdWJzdHJpbmcob2Zmc2V0LCBvZmZzZXQrbWF4KX1gO1xuICAgICAgLy8gfVxuICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KVxuICAgICAgLmFkZFBhc3MoSmF2YVNjcmlwdFNjYW5uZXIuU1RSSU5HX0xJVEVSQUwsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuXG4gICAgICAgIGxldCBtYXRjaFF1b3RlOiBzdHJpbmc7XG4gICAgICAgIGxldCBpZ25vcmVOZXh0TWF0Y2hRdW90ZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgICAgIGxldCBjaGFyID0gZGF0YS5jaGFyQXQob2Zmc2V0KTtcbiAgICAgICAgaWYgKGNoYXIgPT0gXCJcXFwiXCIpIHtcbiAgICAgICAgICBtYXRjaFF1b3RlID0gY2hhcjtcbiAgICAgICAgfSBlbHNlIGlmIChjaGFyID09IFwiJ1wiKSB7XG4gICAgICAgICAgbWF0Y2hRdW90ZSA9IGNoYXI7XG4gICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PSBcImBcIikge1xuICAgICAgICAgIG1hdGNoUXVvdGUgPSBjaGFyO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSBvZmZzZXQgKyAxOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgIGNoYXIgPSBkYXRhLmNoYXJBdChpKTtcbiAgICAgICAgICBpZiAoY2hhciA9PSBtYXRjaFF1b3RlKSB7XG4gICAgICAgICAgICBpZiAoIWlnbm9yZU5leHRNYXRjaFF1b3RlKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgcmVzdWx0LnJlYWRDaGFycysrO1xuICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PSBcIlxcXFxcIikge1xuICAgICAgICAgICAgaWdub3JlTmV4dE1hdGNoUXVvdGUgPSB0cnVlO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoaWdub3JlTmV4dE1hdGNoUXVvdGUpIGlnbm9yZU5leHRNYXRjaFF1b3RlID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoSmF2YVNjcmlwdFNjYW5uZXIuTlVNQkVSX0xJVEVSQUwsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IG1heCA9IE1hdGgubWluKGRhdGEubGVuZ3RoLCBvZmZzZXQgKyAzMDkpO1xuXG4gICAgICAgIC8vbm8gbmVlZCB0byBzY2FuIHBhc3Qgd2hhdCB3ZSBjYW4ndCBoYW5kbGUsIHVzZSBvbmx5IDMwOSBtYXggY2hhcnNcbiAgICAgICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IG1heDsgaSsrKSB7XG4gICAgICAgICAgaWYgKG51bWJlcnMuaW5jbHVkZXMoZGF0YS5jaGFyQXQoaSkpKSB7XG4gICAgICAgICAgICByZXN1bHQucmVhZENoYXJzKys7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBpZiAobnVtYmVycy5pbmNsdWRlcyhkYXRhLmNoYXJBdChvZmZzZXQrbWF4KSkpIHtcbiAgICAgICAgLy8gICByZXN1bHQuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICAvLyAgIHJlc3VsdC5lcnJvciA9IGB0b28gbWFueSBudW1iZXIgY2hhcnMgZm9yIGEgbGl0ZXJhbDogJHtkYXRhLnN1YnN0cmluZyhvZmZzZXQsIG9mZnNldCttYXgpfWA7XG4gICAgICAgIC8vIH1cbiAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhKYXZhU2NyaXB0U2Nhbm5lci5PUEVSQVRPUiwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG4gICAgICAgIGlmIChvcHMuaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhKYXZhU2NyaXB0U2Nhbm5lci5CUkFDS0VULCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGJyYWNrZXRzLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCkpKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMgPSAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoSmF2YVNjcmlwdFNjYW5uZXIuUEFSRU5USEVTSVMsIChkYXRhLCBvZmZzZXQpID0+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogU2Nhbm5lckRhdGEgPSB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgcmVhZENoYXJzOiAwLFxuICAgICAgICAgIHJlYWRMaW5lczogMFxuICAgICAgICB9O1xuICAgICAgICBpZiAocGFyZW4uaW5jbHVkZXMoZGF0YS5jaGFyQXQob2Zmc2V0KSkpIHtcbiAgICAgICAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgICAgICAgcmVzdWx0LnJlYWRDaGFycyA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0pXG4gICAgICAuYWRkUGFzcyhKYXZhU2NyaXB0U2Nhbm5lci5URVJNSU5BVE9SLCAoZGF0YSwgb2Zmc2V0KSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFNjYW5uZXJEYXRhID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHJlYWRDaGFyczogMCxcbiAgICAgICAgICByZWFkTGluZXM6IDBcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKHRlcm1zLmluY2x1ZGVzKGRhdGEuY2hhckF0KG9mZnNldCkpKSB7XG4gICAgICAgICAgcmVzdWx0LnN1Y2Nlc3MgPSB0cnVlO1xuICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMgPSAxO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICAgLmFkZFBhc3MoSmF2YVNjcmlwdFNjYW5uZXIuV0hJVEVTUEFDRSwgKGRhdGEsIG9mZnNldCkgPT4ge1xuICAgICAgICBsZXQgcmVzdWx0OiBTY2FubmVyRGF0YSA9IHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICByZWFkQ2hhcnM6IDAsXG4gICAgICAgICAgcmVhZExpbmVzOiAwXG4gICAgICAgIH07XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IG9mZnNldDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAod3MuaW5jbHVkZXMoZGF0YS5jaGFyQXQoaSkpKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgV1M6IFwiJHtkYXRhLmNoYXJBdChpKX1cImApO1xuICAgICAgICAgICAgaWYgKGRhdGEuY2hhckF0KGkpID09IG5sKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5yZWFkTGluZXMrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJlc3VsdC5yZWFkQ2hhcnMrKztcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5yZWFkQ2hhcnMgPiAwKSB7XG4gICAgICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChyZXN1bHQucmVhZENoYXJzID4gMCkge1xuICAgICAgICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==